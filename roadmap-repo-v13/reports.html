<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Rapports</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Rapports</h1>
    <nav><a href="index.html">Accueil</a></nav>
  </header>
  <main>
    <section class="card">
      <div class="month"><h2>Rapport Hebdomadaire</h2></div>
      <canvas id="weeklyChart"></canvas>
    </section>
    <section class="card">
      <div class="month"><h2>Rapport Mensuel</h2></div>
      <canvas id="monthlyChart"></canvas>
    </section>
  </main>
  <script>
    function getData(keys){
      const res = {};
      keys.forEach(k=>{
        try{ res[k]=JSON.parse(localStorage.getItem(k)||'{}'); }catch(e){ res[k]={}; }
      });
      return res;
    }

    function buildWeekly(){
      const ctx = document.getElementById('weeklyChart');
      const keys = ['car_weekly','moto_weekly','guitar_weekly','dj_weekly','sport_weekly','oulpan_weekly','english_weekly','photo_weekly','ong_weekly'];
      const d = getData(keys);
      const labels = keys.map(k=>k.replace('_weekly',''));
      const values = keys.map(k=>{
        const it = d[k]?.items||{}; return Object.values(it).reduce((a,b)=>a+b,0);
      });
      new Chart(ctx, {
        type:'bar',
        data:{labels:labels, datasets:[{label:'Points hebdo', data:values}]},
        options:{responsive:true, scales:{y:{beginAtZero:true}}}
      });
    }

    function buildMonthly(){
      const ctx = document.getElementById('monthlyChart');
      const d = JSON.parse(localStorage.getItem('timeline_status_v1')||'{}');
      const byMonth={};
      Object.keys(d).forEach(id=>{
        const m = id.split('::')[0];
        byMonth[m]=(byMonth[m]||0)+(d[id]>0?1:0);
      });
      const labels=Object.keys(byMonth).sort();
      const values=labels.map(k=>byMonth[k]);
      new Chart(ctx, {
        type:'line',
        data:{labels:labels, datasets:[{label:'Tâches commencées', data:values, fill:false, borderColor:'blue'}]},
        options:{responsive:true}
      });
    }

    buildWeekly();
    buildMonthly();
  </script>
</body>
</html>
